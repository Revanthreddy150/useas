<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>USEAS - Study Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f6f9;
    }

    header {
      background: linear-gradient(90deg,#4e73df,#1cc88a);
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #fff;
      font-weight: bold;
    }

    .container {
      padding: 20px;
    }

    .section-title {
      margin-top: 30px;
    }

    .card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .new-badge {
      color: red;
      font-weight: bold;
    }

    .hidden {
      display: none;
    }

    input, select {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
    }
  </style>
</head>
<body>

<header>
  <h2>USEAS</h2>
  <div id="authArea">
    <button class="btn" onclick="login()">Login</button>
  </div>
</header>

<div class="container">

  <div id="adminPanel" class="hidden">
    <h3>Admin Upload Panel</h3>
    <input type="text" id="title" placeholder="Title">
    <input type="text" id="description" placeholder="Description">
    <input type="text" id="subject" placeholder="Subject">
    <select id="section">
      <option value="notes">Notes</option>
      <option value="previous_papers">Previous Papers</option>
      <option value="easy_notes">Easy Notes</option>
    </select>
    <input type="file" id="file">
    <button class="btn" onclick="upload()">Upload</button>
  </div>

  <h3 class="section-title">Latest Notes</h3>
  <div id="notes"></div>

  <h3 class="section-title">Previous Papers</h3>
  <div id="previous_papers"></div>

  <h3 class="section-title">Easy Notes</h3>
  <div id="easy_notes"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyArqJycgZtlLpM7KQ2T9h-e2eJUHtMg-TY",
  authDomain: "tff-earns.firebaseapp.com",
  projectId: "tff-earns",
  storageBucket: "tff-earns.firebasestorage.app",
  messagingSenderId: "762695597074",
  appId: "1:762695597074:web:bd7a8df2df2806d5b26ccb"
};

const ADMIN_EMAIL = "ADMIN_EMAIL_HERE@gmail.com";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db = getFirestore(app);
const storage = getStorage(app);

// LOGIN (POPUP FIXED)
window.login = function() {
  signInWithPopup(auth, provider)
    .then(result => console.log("Login success"))
    .catch(error => alert(error.message));
};

window.logout = function() {
  signOut(auth);
};

onAuthStateChanged(auth, user => {
  const authArea = document.getElementById("authArea");
  if (user) {
    authArea.innerHTML = `
      <img src="${user.photoURL}" width="30" style="border-radius:50%">
      ${user.displayName}
      <button class="btn" onclick="logout()">Logout</button>
    `;
    if (user.email === ADMIN_EMAIL) {
      document.getElementById("adminPanel").classList.remove("hidden");
    }
  } else {
    authArea.innerHTML = `<button class="btn" onclick="login()">Login</button>`;
    document.getElementById("adminPanel").classList.add("hidden");
  }
});

// UPLOAD
window.upload = async function() {
  const title = document.getElementById("title").value;
  const description = document.getElementById("description").value;
  const subject = document.getElementById("subject").value;
  const section = document.getElementById("section").value;
  const file = document.getElementById("file").files[0];

  if (!file) return alert("Select file");

  const storageRef = ref(storage, section + "/" + Date.now() + "_" + file.name);
  await uploadBytes(storageRef, file);
  const url = await getDownloadURL(storageRef);

  await addDoc(collection(db, section), {
    title,
    description,
    subject,
    fileURL: url,
    date: serverTimestamp(),
    uploadedBy: auth.currentUser.email
  });

  alert("Uploaded!");
};

// LOAD DATA REALTIME
function loadSection(section) {
  const q = query(collection(db, section), orderBy("date", "desc"));
  onSnapshot(q, snapshot => {
    const container = document.getElementById(section);
    container.innerHTML = "";
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const isNew = data.date?.seconds > (Date.now()/1000 - 86400);
      container.innerHTML += `
        <div class="card">
          <h4>${data.title} ${isNew ? '<span class="new-badge">NEW</span>' : ''}</h4>
          <p>${data.description}</p>
          <p><b>Subject:</b> ${data.subject}</p>
          <a href="${data.fileURL}" target="_blank">Download</a>
        </div>
      `;
    });
  });
}

loadSection("notes");
loadSection("previous_papers");
loadSection("easy_notes");

</script>

</body>
</html>
